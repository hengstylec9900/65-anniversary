<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ping Pong Game</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: #f4f4f4;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    canvas {
      background: #ffffff;
      border: 2px solid #ccc;
      border-radius: 16px;
      touch-action: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="360" height="480"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const paddle = {
      x: canvas.width / 2 - 40,
      y: canvas.height - 30,
      width: 80,
      height: 10,
      speed: 6,
      dx: 0
    };

    const ball = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      radius: 8,
      speed: 4,
      dx: 3,
      dy: -4
    };

    let score = 0;
    let isGameOver = false;

    function drawPaddle() {
      ctx.fillStyle = "#007aff";
      ctx.fillRect(paddle.x, paddle.y, paddle.width, paddle.height);
    }

    function drawBall() {
      ctx.beginPath();
      ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
      ctx.fillStyle = "#ff6b6b";
      ctx.fill();
      ctx.closePath();
    }

    function drawScore() {
      ctx.font = "16px sans-serif";
      ctx.fillStyle = "#333";
      ctx.fillText("冒險積分: " + score, 10, 20);
    }

    function movePaddle() {
      paddle.x += paddle.dx;
      if (paddle.x < 0) paddle.x = 0;
      if (paddle.x + paddle.width > canvas.width) paddle.x = canvas.width - paddle.width;
    }

    function moveBall() {
      ball.x += ball.dx;
      ball.y += ball.dy;

      if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) ball.dx *= -1;
      if (ball.y - ball.radius < 0) ball.dy *= -1;

      if (
        ball.y + ball.radius >= paddle.y &&
        ball.x >= paddle.x &&
        ball.x <= paddle.x + paddle.width
      ) {
        ball.dy *= -1;
        score++;
        playScoreSound();
      }

      if (ball.y - ball.radius > canvas.height) {
        isGameOver = true;
        sendScore(score);
        setTimeout(() => {
          window.location.href = `game_end_screen.html?score=${score}`;
        }, 1000);
      }
    }

    function drawGameOver() {
      ctx.fillStyle = "rgba(0,0,0,0.6)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "white";
      ctx.font = "24px sans-serif";
      ctx.textAlign = "center";
      ctx.fillText("遊戲結束", canvas.width / 2, canvas.height / 2 - 10);
      ctx.fillText("你的冒險積分: " + score, canvas.width / 2, canvas.height / 2 + 30);
    }

    function update() {
      if (isGameOver) {
        drawGameOver();
        return;
      }
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawPaddle();
      drawBall();
      drawScore();
      movePaddle();
      moveBall();
      requestAnimationFrame(update);
    }

    function keyDown(e) {
      if (e.key === "ArrowLeft") paddle.dx = -paddle.speed;
      else if (e.key === "ArrowRight") paddle.dx = paddle.speed;
    }

    function keyUp(e) {
      if (e.key === "ArrowLeft" || e.key === "ArrowRight") paddle.dx = 0;
    }

    document.addEventListener("keydown", keyDown);
    document.addEventListener("keyup", keyUp);

    // 手機觸控支援
    canvas.addEventListener("touchstart", handleTouch);
    canvas.addEventListener("touchmove", handleTouch);

    function handleTouch(e) {
      e.preventDefault();
      const rect = canvas.getBoundingClientRect();
      const touchX = e.touches[0].clientX - rect.left;
      paddle.x = touchX - paddle.width / 2;
      if (paddle.x < 0) paddle.x = 0;
      if (paddle.x + paddle.width > canvas.width) paddle.x = canvas.width - paddle.width;
    }

    function sendScore(score) {
      const name = localStorage.getItem("playerName") || "未知";
      const id = localStorage.getItem("employeeId") || "未填";
      const webhookUrl = "YOUR_POWER_AUTOMATE_WEBHOOK_URL";

      fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: name,
          emp_id: id,
          score: score
        })
      }).then(res => {
        if (res.ok) {
          console.log("分數送出成功");
        } else {
          console.error("分數送出失敗");
        }
      });
    }

    function playScoreSound() {
      const beep = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YRAAAAABAQEBAQEB");
      beep.play();
    }

    update();
  </script>
</body>
</html>
