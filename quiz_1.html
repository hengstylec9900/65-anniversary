<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>恆會答｜Quiz 1（限玩 3 次）</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    :root { --accent:#e430b0; --bg:#f5f7fa; --card:#fff; --text:#111; --muted:#666; }
    *{box-sizing:border-box}
    body{ margin:0;background:var(--bg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:var(--text); }
    .wrap{ max-width:520px;margin:0 auto;padding:20px; }
    .card{ background:var(--card);border-radius:20px;padding:20px;
      box-shadow:0 6px 24px rgba(0,0,0,.06); }
    .title{ display:flex;align-items:center;gap:12px;margin:0 0 8px; }
    .title img{ width:56px;height:auto }
    .subtitle{ color:var(--muted);margin:0 0 12px;font-size:14px }
    .row{ display:flex;justify-content:space-between;gap:10px;margin:8px 0 0;
      color:var(--muted);font-size:13px;align-items:center;flex-wrap:wrap}
    .pill{background:#ffe9f6;color:#b0127f;padding:4px 10px;border-radius:999px;font-weight:600}
    .timer{background:#111;color:#fff;border-radius:999px;padding:4px 10px;font-weight:700}
    .limit{background:#0044cc;color:#fff;border-radius:999px;padding:4px 10px;font-weight:700}
    .q{ border:1px solid #eaeef2;border-radius:14px;padding:14px 14px 8px;margin:12px 0;background:#fff; }
    .q h4{ margin:0 0 10px;font-size:16px;line-height:1.4 }
    .opts{ display:grid;gap:8px }
    .opt{ display:flex;align-items:center;gap:10px;border:1px solid #e6e8ec;
      border-radius:12px;padding:10px 12px;background:#fcfcfd; transition:.15s border, .15s background; }
    .opt input{ transform:scale(1.2) }
    .opt.correct{ border-color:#20c36c;background:#ecfff4 }
    .opt.incorrect{ border-color:#ff6b6b;background:#fff0f0 }
    .opt .flag{ margin-left:auto;font-size:12px;font-weight:700 }
    .footer{ position:sticky;bottom:0;background:linear-gradient(180deg, rgba(245,247,250,0) 0%, #f5f7fa 30%);
      padding:16px 0 4px; }
    .btn{ width:100%;padding:14px 16px;border:none;border-radius:12px;background:var(--accent);
      color:#fff;font-weight:700;font-size:16px;box-shadow:0 8px 20px rgba(228,48,176,.25); }
    .btn:disabled{ opacity:.5 }
    .notice{
      background:#fff3d6;border:1px solid #ffd782;color:#7a4b00;
      padding:10px 12px;border-radius:12px;margin:12px 0;font-size:14px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="title">
        <img src="https://hengstylec9900.github.io/65-anniversary/logo-65.png" alt="65周年"/>
        <div>
          <h2 style="margin:0">恆會答｜Quiz 1</h2>
          <div class="subtitle">每題作答後即鎖定不可再改。倒數 10 秒自動結算。<br/>每位玩家本活動限玩 <b>3 次</b>。</div>
        </div>
      </div>
      <div class="row">
        <div>玩家：<span id="playerName">-</span>｜員編：<span id="employeeId">-</span></div>
        <div class="pill">UID: <span id="uid">-</span></div>
        <div class="timer" id="timer">倒數 10 秒</div>
        <div class="limit" id="limit">剩餘次數：3</div>
      </div>

      <div id="limitNotice" class="notice" style="display:none;"></div>

      <form id="quizForm">
        <div id="questions"></div>
        <div class="footer">
          <button type="submit" id="submitBtn" class="btn" disabled>送出作答並結算</button>
        </div>
      </form>
    </div>
  </div>

<script>
const POINTS_PER_CORRECT = 20;
const QUIZ_NAME = "恆會答｜Quiz 1";
const QUIZ_DURATION_SEC = 10;
const MAX_ATTEMPTS = 3;

const QUESTIONS = [
  { text: "恆隆行自成立以來今年是第65周年？", type: "tf", options: ["正確","錯誤"], answerIndex: 0 },
  { text: "Braun耳溫槍榮獲兒科醫生 No.1 推薦品牌？", type: "tf", options: ["正確","錯誤"], answerIndex: 0 },
  { text: "Joseph Joseph 在 2024 年幾月正式代理上市？", type: "mc", options: ["1 月","3 月","5 月","7 月"], answerIndex: 2 },
  { text: "Panasonic 鹼性電池市調公布市佔率多少？", type: "mc", options:[
      "36%，且是市場第一領導品牌。",
      "36%，且是市占率第二品牌。",
      "41%，且是市場第一領導品牌。",
      "41%，且是市占率第二品牌。"
    ], answerIndex: 2 },
  { text: "恆隆行目前代理品牌總數量為多少？", type: "mc",
    options: ["20 個品牌","25 個品牌","29 個品牌","33 個品牌"], answerIndex: 2 }
];

let ATTEMPTS_KEY = "quiz_history_attempts_device"; // 預設裝置層級，抓到 UID 後會換掉
let leftSeconds = QUIZ_DURATION_SEC;
let lockedOut = false;

async function initLIFF() {
  try {
    await liff.init({ liffId: "2007968657-RQJnjPVA" });
    if (liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      if (profile?.userId) localStorage.setItem("uid", profile.userId);
    }
  } catch(e) { console.warn("LIFF init skipped/failed:", e); }
}

function twNowString() {
  return new Date(Date.now()+8*60*60*1000).toISOString().slice(0,19).replace("T"," ");
}

function getAttemptsKey() {
  const uid = localStorage.getItem("uid");
  return uid ? `quiz_history_attempts_${uid}` : "quiz_history_attempts_device";
}

function readAttempts() {
  const n = parseInt(localStorage.getItem(ATTEMPTS_KEY) || "0", 10);
  return isNaN(n) ? 0 : n;
}

function writeAttempts(n) {
  localStorage.setItem(ATTEMPTS_KEY, String(n));
}

function updateLimitUI() {
  const used = readAttempts();
  const remain = Math.max(0, MAX_ATTEMPTS - used);
  document.getElementById("limit").textContent = `剩餘次數：${remain}`;
  if (remain <= 0) {
    lockedOut = true;
    disableQuiz("已達最多 3 次的上限。本活動此關卡不可再作答。");
  }
}

function disableQuiz(message) {
  const notice = document.getElementById("limitNotice");
  notice.textContent = message;
  notice.style.display = "block";

  // 禁用所有輸入與提交
  document.querySelectorAll('input[type="radio"]').forEach(i => i.disabled = true);
  document.getElementById("submitBtn").disabled = true;

  // 停止計時顯示
  const t = document.getElementById("timer");
  t.textContent = "已鎖定";
}

function fillUser() {
  const name = localStorage.getItem("playerName") || "匿名";
  const empId = localStorage.getItem("employeeId") || "未填";
  const uid = localStorage.getItem("uid") || "-";
  document.getElementById("playerName").textContent = name;
  document.getElementById("employeeId").textContent = empId;
  document.getElementById("uid").textContent = uid.length>6 ? (uid.slice(0,6)+"…") : uid;
}

function renderQuestions() {
  const wrap = document.getElementById("questions");
  wrap.innerHTML = "";
  QUESTIONS.forEach((q, qi) => {
    const qEl = document.createElement("div");
    qEl.className = "q";
    qEl.innerHTML = `<h4>${qi+1}. ${q.text}</h4>`;
    const opts = document.createElement("div");
    opts.className = "opts";
    q.options.forEach((opt, oi) => {
      const label = document.createElement("label");
      label.className = "opt";
      label.setAttribute("data-q", qi);
      label.setAttribute("data-o", oi);
      label.innerHTML = `
        <input type="radio" name="q${qi}" value="${oi}">
        <span>${opt}</span>
        <span class="flag" hidden></span>
      `;
      opts.appendChild(label);
    });
    qEl.appendChild(opts);
    wrap.appendChild(qEl);
  });

  // 事件委派：作答即鎖定
  wrap.addEventListener("change", (e)=>{
    if (e.target && e.target.matches('input[type="radio"]')) {
      if (lockedOut) return;
      const label = e.target.closest(".opt");
      const qi = Number(label.getAttribute("data-q"));
      const oi = Number(label.getAttribute("data-o"));

      // 若本題已鎖定就不再處理
      const qBlock = wrap.querySelector(`.q:nth-child(${qi+1})`);
      if (qBlock?.getAttribute("data-locked") === "1") return;

      // 標記正誤
      const isCorrect = oi === QUESTIONS[qi].answerIndex;
      label.classList.add(isCorrect ? "correct" : "incorrect");
      const flag = label.querySelector(".flag");
      if (flag) { flag.hidden = false; flag.textContent = isCorrect ? "✔ 正確" : "✘ 錯誤"; }

      if (!isCorrect) {
        const correctLabel = wrap.querySelector(`.opt[data-q="${qi}"][data-o="${QUESTIONS[qi].answerIndex}"]`);
        if (correctLabel) {
          correctLabel.classList.add("correct");
          const f2 = correctLabel.querySelector(".flag");
          if (f2) { f2.hidden = false; f2.textContent = "✔ 正解"; }
        }
      }

      // 鎖定本題：禁用所有選項
      wrap.querySelectorAll(`.opt[data-q="${qi}"] input[type="radio"]`).forEach(input => input.disabled = true);
      qBlock.setAttribute("data-locked", "1");

      // 啟用提交按鈕（至少作答 1 題即可；也可改成必答全部）
      document.getElementById("submitBtn").disabled = false;
    }
  });
}

function grade() {
  let correct = 0;
  QUESTIONS.forEach((q, qi)=>{
    const checked = document.querySelector(`input[name="q${qi}"]:checked`);
    if (checked && Number(checked.value) === q.answerIndex) correct++;
  });
  return correct * POINTS_PER_CORRECT;
}

function submitQuiz(e){
  e.preventDefault();
  if (lockedOut) return;
  finalize();
}

function finalize(auto=false){
  if (lockedOut) return;

  // 增加一次嘗試次數
  const used = readAttempts();
  if (used >= MAX_ATTEMPTS) { updateLimitUI(); return; }
  writeAttempts(used + 1);

  const score = grade();
  const prevTotal = parseInt(localStorage.getItem("totalScore") || "0", 10);
  const newTotal = prevTotal + score;
  localStorage.setItem("totalScore", newTotal);
  localStorage.setItem("latestScore", score);
  localStorage.setItem("currentGame", QUIZ_NAME);
  localStorage.setItem("currentGameFile", "quiz_1.html");

  const payload = {
    login_time: twNowString(),
    uid: localStorage.getItem("uid") || "unknown",
    playerName: localStorage.getItem("playerName") || "匿名",
    employeeId: localStorage.getItem("employeeId") || "未填",
    game_name: QUIZ_NAME,
    score: score,
    total_score: newTotal,
    auto_submit: auto,
    attempts_used: used + 1,
    attempts_max: MAX_ATTEMPTS
  };

  fetch("https://defaultd4adf1368c41437283cecd805049bd.23.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/f37895b64f074ea1bdb40f14c4fbbfb9/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=cE-TkpRymVO7a3co5lI1ZTY7xBYKKoCiANkFzzLDK3U", {
    method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)
  }).finally(()=>{
    window.location.href = "game_end_screen.html";
  });
}

// 倒數計時
function startTimer() {
  const el = document.getElementById("timer");
  el.textContent = `倒數 ${leftSeconds} 秒`;
  const t = setInterval(()=>{
    if (lockedOut) { clearInterval(t); return; }
    leftSeconds--;
    el.textContent = `倒數 ${leftSeconds} 秒`;
    if (leftSeconds <= 0) {
      clearInterval(t);
      finalize(true);
    }
  }, 1000);
}

initLIFF().finally(()=>{
  // 設定 UID 後才決定 attempts key
  ATTEMPTS_KEY = getAttemptsKey();

  fillUser();
  renderQuestions();
  updateLimitUI();
  startTimer();

  document.getElementById("quizForm").addEventListener("submit", submitQuiz);
});
</script>
</body>
</html>
